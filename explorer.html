<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Visual Genome Relation Explorer</title>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//cdn.rawgit.com/newrelic-forks/d3-plugins-sankey/master/sankey.js"></script>
    <script src="//cdn.rawgit.com/misoproject/d3.chart/master/d3.chart.min.js"></script>
    <script src="//cdn.rawgit.com/q-m/d3.chart.sankey/master/d3.chart.sankey.min.js"></script>
    <style>
      body {
        font: 10px sans-serif;
        
        position:absolute;
        top:2%;
        bottom:0px;
        left:5%;
        right:0px;
      }
      #chart {
        width: 95%;
        height: 95%;
      }
      .node rect {
        fill-opacity: .9;
        shape-rendering: crispEdges;
      }
      .node text {
        font-size: 14px;
        pointer-events: none;
        text-shadow: 0 1px 0 #fff;
      }
      .link {
        fill: none;
        stroke: #000;
        stroke-opacity: .2;
      }
      .link:hover {
        stroke-opacity: .5;
      }
    </style>
  </head>
  <body>
    <div id="chart" ></div>
    Subject: <input type="text" id="subject">
    <input type="button" onclick="createSankey(document.getElementById('subject').value)" value="Submit">
    <span id="loadError" style="color:red; visibility:hidden">Error: subject not in database. Please make another selection.</span>
    
    <script>
        /* Accepts a dict of dicts... of numbers.
        Returns the sum of all the 'leaf node' numbers in this data structure. */ 
        function sumBranches(obj) {
            var total = 0;
            for (var key in obj) {
                if (typeof obj[key] == 'object') {
                    total += sumBranches(obj[key]);
                } else {
                    total += obj[key];
                }
            }
            return total;
        }
        
        /* Given a subject name and an optional relation name, generates data for a
        Sankey visualization and displays it in the page. */
        function createSankey(subjName, relName=null) {
            d3.json("data/subjects/" + subjName + ".json", function(error, json) {
                if (error != null) {
                    console.log(error);
                    document.getElementById('loadError').style.visibility='visible';
                    return;
                }
                document.getElementById('loadError').style.visibility='hidden';
                if (relName == null) {
                    sankeyData = genSubjData(subjName, json);
                } else {
                    sankeyData = genSubjRelData(subjName, relName, json);
                }
                
                displaySankey(sankeyData);
            });
        }
        
        /* Takes in a subject name and its corresponding dict of relations.
        Generates lists of nodes and links for a Sankey diagram. */ 
        function genSubjData(subjName, subj) {
            var nodes = [{ name: subjName, type: 'subj' }];
            var links = [];
            
            // keep track of indices of objects and relations so we can link things
            var relIndices = {};
            var objIndices = {};
            currIndex = 1;

            topRels = Object.keys(subj).sort(function(a,b){
                return sumBranches(subj[b])-sumBranches(subj[a]);
            }).slice(0,30);
            topRels.forEach(function (relName) {
                relIndices[relName] = currIndex;
                currIndex++;
                nodes.push({ name: relName, type: 'rel' });
                links.push({
                    source: 0,
                    target: relIndices[relName],
                    value: sumBranches(subj[relName])
                });
                topObjs = Object.keys(subj[relName]).sort(function(a,b){
                    return subj[relName][b] - subj[relName][a];
                }).slice(0,4);
                topObjs.forEach(function (objName) {
                    if (!(objName in objIndices)) {
                        objIndices[objName] = currIndex;
                        nodes.push({ name: objName, type: 'obj' });
                        currIndex++;
                    }
                    links.push({
                        source: relIndices[relName],
                        target: objIndices[objName],
                        value: subj[relName][objName]
                    });
                });
            })
            return { nodes: nodes, links: links };
        }
        
        /* Takes in a subject name, a relation name, and its corresponding dict of relations.
        Generates lists of nodes and links for a Sankey diagram (focused on the relation). */ 
        function genSubjRelData(subjName, relName, subj) {
            var nodes = [{ name: subjName, type: 'subj' },
                         { name: relName, type: 'rel' }];
            var links = [{ source: 0, target: 1, value: sumBranches(subj[relName]) }];
            
            topObjs = Object.keys(subj[relName]).sort(function(a,b){
                    return subj[relName][b] - subj[relName][a];
                }).slice(0, 30);
            topObjs.forEach(function (objName) {
                nodes.push({ name: objName, type: 'obj' });
                links.push({
                    source: 1,
                    target: nodes.length-1,
                    value: subj[relName][objName]
                });
            });
            
            return { nodes: nodes, links: links }
        }
        
        /* Draws the diagram and initializes click handlers and tooltips. */
        function displaySankey(sankeyData) {
            d3.select("svg").remove(); // clear existing chart
            var chart = d3.select("#chart").append("svg").chart("Sankey.Path");
            chart
                .colorLinks('#a0a0a0')
                .nodeWidth(20)
                .spread(true)
                .on('node:click', function(node) {
                    if (node.type == 'rel') {
                        createSankey(sankeyData.nodes[0].name, node.name);
                    } else {
                        createSankey(node.name);
                    }
                })
                .on('link:click', function(link) {
                    if (link.source.type == 'subj') {
                        createSankey(link.source.name, link.target.name);
                    } else {
                        createSankey(link.target.name);
                    }
                })
                .draw(sankeyData);
            // add tooltips to links
            d3.select("svg").selectAll(".link").append("title").text(function(link) {
                return link.source.name + " â†’ " + link.target.name + "\n" + link.value + " occurrences"
            });
        }
        
        // example chart on load
        createSankey('kiwi');
        
    </script>
  </body>
</html>